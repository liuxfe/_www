<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="Cache-Control" content="no-transform"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="apple-mobile-web-app-capable" content="Liuxfe的博客"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="browsermode" content="application"><meta name="screen-orientation" content="portrait"><meta name="keywords" content="source"><meta name="description" content="the-super-tiny-compiler详细中文注释 the-super-tiny-compiler
前言稍微接触一点前端，我们都知道现在前端“ES6即正义”，然而浏览器的支持还处于进行阶..."><title>有史以来最小的编译器源码解析 | Liuxfe的博客</title><link rel="icon" href="https://cdn.jsdelivr.net/gh/liuxfe/assets/avatar.jpg"><link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css"><link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css"><link rel="stylesheet" href="/css/style.css?rev=@@hash.css"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9312750344484857" crossorigin="anonymous"></script></head><!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]--><!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]--><body><header class="main-header" style="background-image:url(https://hexo-theme-snippet-1251680922.cos.ap-beijing.myqcloud.com/img/banner.jpg)"><div class="main-header-box"><a class="header-avatar" href="/" title="Liuxfe"><img src="https://cdn.jsdelivr.net/gh/liuxfe/assets/avatar.jpg" alt="logo头像" class="img-responsive center-block"></a><div class="branding"><h2>-------------</h2></div></div></header><nav class="main-navigation"><div class="container"><div class="row"><div class="col-sm-12"><div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav"><span class="sr-only"></span> <i class="fa fa-bars"></i> </span><a class="navbar-brand" href="https://www.liuxfe.com">Liuxfe的博客</a></div><div class="collapse navbar-collapse" id="main-menu"><ul class="menu"><li role="presentation" class="text-center"><a href="/"><i class="fa"></i> 首页</a></li><li role="presentation" class="text-center"><a href="/blog/"><i class="fa"></i> 博客</a></li><li role="presentation" class="text-center"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhwiki.netlify.app"><i class="fa"></i> 维基百科</a></li></ul></div></div></div></div></nav><section class="content-wrap"><div class="container"><div class="row"><main class="col-md-8 main-content m-post"><p id="process"></p><article class="post"><div class="post-head"><h1 id="有史以来最小的编译器源码解析">有史以来最小的编译器源码解析</h1><div class="post-meta"><span class="categories-meta fa-wrap"><i class="fa fa-folder-open-o"></i> <a class="category-link" href="/blog/category/the-super-tiny-compiler/">the-super-tiny-compiler</a> </span><span class="fa-wrap"><i class="fa fa-tags"></i> <span class="tags-meta"><a class="tag-none-link" href="/blog/tagged/source/" rel="tag">source</a> </span></span><span class="fa-wrap"><i class="fa fa-clock-o"></i> <span class="date-meta">2018/09/14</span></span></div><p class="fa fa-exclamation-triangle warning">本文于<strong> 1342</strong> 天之前发表，文中内容可能已经过时。</p></div><div class="post-body post-content"><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jamiebuilds/the-super-tiny-compiler">the-super-tiny-compiler</a><br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/sosout/astc">详细中文注释 the-super-tiny-compiler</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>稍微接触一点前端，我们都知道现在前端“ES6即正义”，然而浏览器的支持还处于进行阶段，所以我们常常会用一个神奇的工具将 ES6 语法转换为目前支持比较广泛的 ES5 语法，这里我们所说的神奇的工具就是编译器。编译器功能非常纯粹，将字符串形式的输入语言编译成目标语言的代码字符串（以及sourcemap），常用的编译器除了我们熟知的 Babel 之外，还有 gcc。不过我们今天的主角是号称可能是有史以来最小的编译器<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jamiebuilds/the-super-tiny-compiler">the-super-tiny-compiler</a>，去掉注释也就200多行代码，作者 James Kyle 更是 Babel 的活跃维护者之一。这个编译器的功能很简单，主要把 Lisp 风格的函数调用转换成 C 风格的，例如：</p><table><thead><tr><th></th><th>Lisp 风格（转化前）</th><th>C 风格（转化后）</th></tr></thead><tbody><tr><td>2 + 2</td><td>(add 2 2)</td><td>add(2, 2)</td></tr><tr><td>4 - 2</td><td>(subtract 4 2)</td><td>subtract(4, 2)</td></tr><tr><td>2 + (4 - 2)</td><td>(add 2 (subtract 4 2))</td><td>add(2, subtract(4, 2))</td></tr></tbody></table><h2 id="编译器工作的三个阶段"><a href="#编译器工作的三个阶段" class="headerlink" title="编译器工作的三个阶段"></a>编译器工作的三个阶段</h2><p>绝大多数编译器的编译过程都差不多，主要分为三个阶段：<br><strong>解析：</strong>将代码字符串解析成抽象语法树。<br><strong>转换：</strong>对抽象语法树进行转换操作。<br><strong>代码生成：</strong>根据转换后的抽象语法树生成目标代码字符串。</p><h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>解析过程主要分为两部分：词法分析和语法分析。<br><strong>1、</strong>词法分析是由词法分析器把原始代码字符串转换成一系列词法单元（token），词法单元是一个数组，由一系列描述独立语法的对象组成，它们可以是数值、标签、标点符号、运算符、括号等。<br><strong>2、</strong>语法分析是由语法分析器将词法分析器生成的词法单元转化为能够描述语法结构（包括语法成分及其关系）的中间表示形式（Intermediate Representation）或抽象语法树（Abstract Syntax Tree），其中抽象语法树（简称AST）是个深层嵌套的对象。</p><p>我们简单看一下 the-super-tiny-compiler 的整个解析过程：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 原始代码字符串
(add 2 (subtract 4 2))

&#x2F;&#x2F; 词法分析转化后生成的词法单元
[
  &#123; type: &#39;paren&#39;,  value: &#39;(&#39;        &#125;,
  &#123; type: &#39;name&#39;,   value: &#39;add&#39;      &#125;,
  &#123; type: &#39;number&#39;, value: &#39;2&#39;        &#125;,
  &#123; type: &#39;paren&#39;,  value: &#39;(&#39;        &#125;,
  &#123; type: &#39;name&#39;,   value: &#39;subtract&#39; &#125;,
  &#123; type: &#39;number&#39;, value: &#39;4&#39;        &#125;,
  &#123; type: &#39;number&#39;, value: &#39;2&#39;        &#125;,
  &#123; type: &#39;paren&#39;,  value: &#39;)&#39;        &#125;,
  &#123; type: &#39;paren&#39;,  value: &#39;)&#39;        &#125;,
]

&#x2F;&#x2F; 语法分析转化后生成的抽象语法树（AST）
&#123;
  type: &#39;Program&#39;,
  body: [&#123;
    type: &#39;CallExpression&#39;,
    name: &#39;add&#39;,
    params: [&#123;
      type: &#39;NumberLiteral&#39;,
      value: &#39;2&#39;,
    &#125;, &#123;
      type: &#39;CallExpression&#39;,
      name: &#39;subtract&#39;,
      params: [&#123;
        type: &#39;NumberLiteral&#39;,
        value: &#39;4&#39;,
      &#125;, &#123;
        type: &#39;NumberLiteral&#39;,
        value: &#39;2&#39;,
      &#125;]
    &#125;]
  &#125;]
&#125;</code></pre><h3 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h3><p>转换过程主要任务是修改 AST，即遍历解析过程生成的 AST，同时进行一系列操作，比如增/删/改节点、增/删/改属性、创建新树等，我们简单看一下 the-super-tiny-compiler 的整个转换过程：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 原始代码字符串
(add 2 (subtract 4 2))

&#x2F;&#x2F; 解析过程生成的 AST
&#123;
  type: &#39;Program&#39;,
  body: [&#123;
    type: &#39;CallExpression&#39;,
    name: &#39;add&#39;,
    params: [&#123;
      type: &#39;NumberLiteral&#39;,
      value: &#39;2&#39;,
    &#125;, &#123;
      type: &#39;CallExpression&#39;,
      name: &#39;subtract&#39;,
      params: [&#123;
        type: &#39;NumberLiteral&#39;,
        value: &#39;4&#39;,
      &#125;, &#123;
        type: &#39;NumberLiteral&#39;,
        value: &#39;2&#39;,
      &#125;]
    &#125;]
  &#125;]
&#125;

&#x2F;&#x2F; 转换过程生成的 AST
&#123;
  type: &#39;Program&#39;,
  body: [&#123;
    type: &#39;ExpressionStatement&#39;,
    expression: &#123;
      type: &#39;CallExpression&#39;,
      callee: &#123;
        type: &#39;Identifier&#39;,
        name: &#39;add&#39;
      &#125;,
      arguments: [&#123;
        type: &#39;NumberLiteral&#39;,
        value: &#39;2&#39;
      &#125;, &#123;
        type: &#39;CallExpression&#39;,
        callee: &#123;
          type: &#39;Identifier&#39;,
          name: &#39;subtract&#39;
        &#125;,
        arguments: [&#123;
          type: &#39;NumberLiteral&#39;,
          value: &#39;4&#39;
        &#125;, &#123;
          type: &#39;NumberLiteral&#39;,
          value: &#39;2&#39;
        &#125;]
      &#125;
    &#125;
  &#125;]
&#125;</code></pre><h3 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h3><p>根据转换过程生成的抽象语法树生成目标代码字符串。</p><h2 id="源码实现"><a href="#源码实现" class="headerlink" title="源码实现"></a>源码实现</h2><p>接下来我们根据编译器工作的三个阶段逐一分析一下 the-super-tiny-compiler 源码实现。</p><h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><p>词法分析器主要任务把原始代码字符串转换成一系列词法单元（token）。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 词法分析器 参数：代码字符串input
function tokenizer(input) &#123;
  &#x2F;&#x2F; 当前正在处理的字符索引
  let current &#x3D; 0;
  &#x2F;&#x2F; 词法单元数组
  let tokens &#x3D; [];

  &#x2F;&#x2F; 遍历字符串，获得词法单元数组
  while (current &lt; input.length) &#123;
    let char &#x3D; input[current];

    &#x2F;&#x2F; 匹配左括号
    if (char &#x3D;&#x3D;&#x3D; &#39;(&#39;) &#123;

      &#x2F;&#x2F; type 为 &#39;paren&#39;，value 为左圆括号的对象
      tokens.push(&#123;
        type: &#39;paren&#39;,
        value: &#39;(&#39;
      &#125;);

      &#x2F;&#x2F; current 自增
      current++;

      &#x2F;&#x2F; 结束本次循环，进入下一次循环
      continue;
    &#125;

    &#x2F;&#x2F; 匹配右括号
    if (char &#x3D;&#x3D;&#x3D; &#39;)&#39;) &#123;
      tokens.push(&#123;
        type: &#39;paren&#39;,
        value: &#39;)&#39;
      &#125;);

      current++;

      continue;
    &#125;

    &#x2F;&#x2F; \s：匹配任何空白字符，包括空格、制表符、换页符、换行符、垂直制表符等
    let WHITESPACE &#x3D; &#x2F;\s&#x2F;;
    &#x2F;&#x2F; 跳过空白字符
    if (WHITESPACE.test(char)) &#123;
      current++;
      continue;
    &#125;

    &#x2F;&#x2F; [0-9]：匹配一个数字字符
    let NUMBERS &#x3D; &#x2F;[0-9]&#x2F;;
    &#x2F;&#x2F; 匹配数值
    if (NUMBERS.test(char)) &#123;
      let value &#x3D; &#39;&#39;;
      &#x2F;&#x2F; 匹配连续数字，作为数值
      while (NUMBERS.test(char)) &#123;
        value +&#x3D; char;
        char &#x3D; input[++current];
      &#125;
      tokens.push(&#123;
        type: &#39;number&#39;,
        value
      &#125;);

      continue;
    &#125;

    &#x2F;&#x2F; 匹配形如&quot;abc&quot;的字符串
    if (char &#x3D;&#x3D;&#x3D; &#39;&quot;&#39;) &#123;
      let value &#x3D; &#39;&#39;;

      &#x2F;&#x2F; 跳跃左双引号
      char &#x3D; input[++current];

      &#x2F;&#x2F; 获取两个双引号之间的所有字符
      while (char !&#x3D;&#x3D; &#39;&quot;&#39;) &#123;
        value +&#x3D; char;
        char &#x3D; input[++current];
      &#125;

      &#x2F;&#x2F; 跳跃右双引号
      char &#x3D; input[++current];

      tokens.push(&#123;
        type: &#39;string&#39;,
        value
      &#125;);

      continue;
    &#125;

    &#x2F;&#x2F; [a-z]：匹配1个小写字符 i 模式中的字符将同时匹配大小写字母
    let LETTERS &#x3D; &#x2F;[a-z]&#x2F;i;
    &#x2F;&#x2F; 匹配函数名，要求只含大小写字母
    if (LETTERS.test(char)) &#123;
      let value &#x3D; &#39;&#39;;

      &#x2F;&#x2F; 获取连续字符
      while (LETTERS.test(char)) &#123;
        value +&#x3D; char;
        char &#x3D; input[++current];
      &#125;

      tokens.push(&#123;
        type: &#39;name&#39;,
        value
      &#125;);

      continue;
    &#125;

    &#x2F;&#x2F; 无法识别的字符，抛出错误提示
    throw new TypeError(&#39;I dont know what this character is: &#39; + char);
  &#125;

  &#x2F;&#x2F; 词法分析器的最后返回词法单元数组
  return tokens;
&#125;</code></pre><p>通过遍历代码字符串，分拣出各个词素，然后构成由一系列描述独立语法的对象组成的数组的词法单元。</p><h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p>语法分析器主要任务是将词法分析器生成的词法单元转化为能够描述语法结构（包括语法成分及其关系）的中间表示形式（Intermediate Representation）或抽象语法树（Abstract Syntax Tree）。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 语法分析器 参数：词法单元数组
function parser(tokens) &#123;
  &#x2F;&#x2F; 当前正在处理的 token 索引
  let current &#x3D; 0;
  &#x2F;&#x2F; 递归遍历（因为函数调用允许嵌套），将 token 转成 AST 节点
  function walk() &#123;
    &#x2F;&#x2F; 获取当前 token
    let token &#x3D; tokens[current];

    &#x2F;&#x2F; 数值
    if (token.type &#x3D;&#x3D;&#x3D; &#39;number&#39;) &#123;
      &#x2F;&#x2F; current 自增
      current++;

      &#x2F;&#x2F; 生成一个 AST节点 &#39;NumberLiteral&#39;，用来表示数值字面量
      return &#123;
        type: &#39;NumberLiteral&#39;,
        value: token.value,
      &#125;;
    &#125;

    &#x2F;&#x2F; 字符串
    if (token.type &#x3D;&#x3D;&#x3D; &#39;string&#39;) &#123;
      current++;

      &#x2F;&#x2F; 生成一个 AST节点 &#39;StringLiteral&#39;，用来表示字符串字面量
      return &#123;
        type: &#39;StringLiteral&#39;,
        value: token.value,
      &#125;;
    &#125;

    &#x2F;&#x2F; 函数
    if (token.type &#x3D;&#x3D;&#x3D; &#39;paren&#39; &amp;&amp; token.value &#x3D;&#x3D;&#x3D; &#39;(&#39;) &#123;
      &#x2F;&#x2F; 跳过左括号，获取下一个 token 作为函数名
      token &#x3D; tokens[++current];

      let node &#x3D; &#123;
        type: &#39;CallExpression&#39;,
        name: token.value,
        params: []
      &#125;;

      &#x2F;&#x2F; 再次自增 &#96;current&#96; 变量，获取参数 token
      token &#x3D; tokens[++current];

      &#x2F;&#x2F; 右括号之前的所有token都属于参数
      while ((token.type !&#x3D;&#x3D; &#39;paren&#39;) || (token.type &#x3D;&#x3D;&#x3D; &#39;paren&#39; &amp;&amp; token.value !&#x3D;&#x3D; &#39;)&#39;)) &#123;
        node.params.push(walk());
        token &#x3D; tokens[current];
      &#125;

      &#x2F;&#x2F; 跳过右括号
      current++;

      return node;
    &#125;
    &#x2F;&#x2F; 无法识别的字符，抛出错误提示
    throw new TypeError(token.type);
  &#125;

  &#x2F;&#x2F; AST的根节点
  let ast &#x3D; &#123;
    type: &#39;Program&#39;,
    body: [],
  &#125;;

  &#x2F;&#x2F; 填充ast.body
  while (current &lt; tokens.length) &#123;
    ast.body.push(walk());
  &#125;

  &#x2F;&#x2F; 最后返回ast
  return ast;
&#125;</code></pre><p>通过递归来将词法分析器生成的词法单元转化为能够描述语法结构的 ast。</p><h3 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 遍历器
function traverser(ast, visitor) &#123;
  &#x2F;&#x2F; 遍历 AST节点数组 对数组中的每一个元素调用 &#96;traverseNode&#96; 函数。
  function traverseArray(array, parent) &#123;
    array.forEach(child &#x3D;&gt; &#123;
      traverseNode(child, parent);
    &#125;);
  &#125;

  &#x2F;&#x2F; 接受一个 &#96;node&#96; 和它的父节点 &#96;parent&#96; 作为参数
  function traverseNode(node, parent) &#123;
    &#x2F;&#x2F; 从 visitor 获取对应方法的对象
    let methods &#x3D; visitor[node.type];
    &#x2F;&#x2F; 通过 visitor 对应方法操作当前 node
    if (methods &amp;&amp; methods.enter) &#123;
      methods.enter(node, parent);
    &#125;

    switch (node.type) &#123;
      &#x2F;&#x2F; 根节点
      case &#39;Program&#39;:
        traverseArray(node.body, node);
        break;
      &#x2F;&#x2F; 函数调用
      case &#39;CallExpression&#39;:
        traverseArray(node.params, node);
        break;
      &#x2F;&#x2F; 数值和字符串，不用处理
      case &#39;NumberLiteral&#39;:
      case &#39;StringLiteral&#39;:
        break;

      &#x2F;&#x2F; 无法识别的字符，抛出错误提示
      default:
        throw new TypeError(node.type);
    &#125;
    if (methods &amp;&amp; methods.exit) &#123;
      methods.exit(node, parent);
    &#125;
  &#125;
  &#x2F;&#x2F; 开始遍历
  traverseNode(ast, null);
&#125;</code></pre><p>通过递归遍历 AST，在遍历过程中通过 visitor 对应方法操作当前 node，这里和切面差不多。</p><h3 id="转换-1"><a href="#转换-1" class="headerlink" title="转换"></a>转换</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 转化器，参数：AST
function transformer(ast) &#123;
  &#x2F;&#x2F; 创建 &#96;newAST&#96;，它与之前的 AST 类似，Program：新AST的根节点
  let newAst &#x3D; &#123;
    type: &#39;Program&#39;,
    body: [],
  &#125;;

  &#x2F;&#x2F; 通过 _context 维护新旧 AST，注意 _context 是一个引用，从旧的 AST 到新的 AST。
  ast._context &#x3D; newAst.body;

  &#x2F;&#x2F; 通过遍历器遍历 参数：AST 和 visitor
  traverser(ast, &#123;
    &#x2F;&#x2F; 数值，直接原样插入新AST
    NumberLiteral: &#123;
      enter(node, parent) &#123;
        parent._context.push(&#123;
          type: &#39;NumberLiteral&#39;,
          value: node.value,
        &#125;);
      &#125;,
    &#125;,
    &#x2F;&#x2F; 字符串，直接原样插入新AST
    StringLiteral: &#123;
      enter(node, parent) &#123;
        parent._context.push(&#123;
          type: &#39;StringLiteral&#39;,
          value: node.value,
        &#125;);
      &#125;,
    &#125;,
    &#x2F;&#x2F; 函数调用
    CallExpression: &#123;
      enter(node, parent) &#123;
        &#x2F;&#x2F; 创建不同的AST节点
        let expression &#x3D; &#123;
          type: &#39;CallExpression&#39;,
          callee: &#123;
            type: &#39;Identifier&#39;,
            name: node.name,
          &#125;,
          arguments: [],
        &#125;;

        &#x2F;&#x2F; 函数调用有子类，建立节点对应关系，供子节点使用
        node._context &#x3D; expression.arguments;

        &#x2F;&#x2F; 顶层函数调用算是语句，包装成特殊的AST节点
        if (parent.type !&#x3D;&#x3D; &#39;CallExpression&#39;) &#123;

          expression &#x3D; &#123;
            type: &#39;ExpressionStatement&#39;,
            expression: expression,
          &#125;;
        &#125;
        parent._context.push(expression);
      &#125;,
    &#125;
  &#125;);
  &#x2F;&#x2F; 最后返回新 AST
  return newAst;
&#125;</code></pre><p>这里通过 _context 引用维护新旧 AST，简单方便，但会污染旧AST。</p><h3 id="代码生成-1"><a href="#代码生成-1" class="headerlink" title="代码生成"></a>代码生成</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; 代码生成器 参数：新 AST
function codeGenerator(node) &#123;

  switch (node.type) &#123;
    &#x2F;&#x2F; 遍历 body 属性中的节点，且递归调用 codeGenerator，结果按行输出
    case &#39;Program&#39;:
      return node.body.map(codeGenerator)
        .join(&#39;\n&#39;);

    &#x2F;&#x2F; 表达式，处理表达式内容，并用分号结尾
    case &#39;ExpressionStatement&#39;:
      return (
        codeGenerator(node.expression) +
        &#39;;&#39;
      );

    &#x2F;&#x2F; 函数调用，添加左右括号，参数用逗号隔开
    case &#39;CallExpression&#39;:
      return (
        codeGenerator(node.callee) +
        &#39;(&#39; +
        node.arguments.map(codeGenerator)
          .join(&#39;, &#39;) +
        &#39;)&#39;
      );

    &#x2F;&#x2F; 标识符，数值，原样输出
    case &#39;Identifier&#39;:
      return node.name;
    case &#39;NumberLiteral&#39;:
      return node.value;

    &#x2F;&#x2F; 字符串，用双引号包起来再输出
    case &#39;StringLiteral&#39;:
      return &#39;&quot;&#39; + node.value + &#39;&quot;&#39;;

    &#x2F;&#x2F; 无法识别的字符，抛出错误提示
    default:
      throw new TypeError(node.type);
  &#125;
&#125;</code></pre><p>根据转换后的新AST生成目标代码字符串。</p><h3 id="编译器"><a href="#编译器" class="headerlink" title="编译器"></a>编译器</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">function compiler(input) &#123;
  let tokens &#x3D; tokenizer(input);
  let ast    &#x3D; parser(tokens);
  let newAst &#x3D; transformer(ast);
  let output &#x3D; codeGenerator(newAst);

  return output;
&#125;</code></pre><p>编译器整个工作流程：<br><strong>1、</strong>input =&gt; tokenizer =&gt; tokens<br><strong>2、</strong>tokens =&gt; parser =&gt; ast<br><strong>3、</strong>ast =&gt; transformer =&gt; newAst<br><strong>4、</strong>newAst =&gt; generator =&gt; output<br>将上面流程串起来，就构成了简单的编译器。</p></div><div class="post-footer"><div></div><div></div></div></article><div class="article-nav prev-next-wrap clearfix"><a href="/blog/2018/09/49719.html" class="pre-post btn btn-default" title="Java面向对象设计之工厂方法模式"><i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span> <span class="hidden-xs">Java面向对象设计之工厂方法模式</span> </a><a href="/blog/2018/09/61471.html" class="next-post btn btn-default" title="Java面向对象设计之装饰模式"><span class="hidden-lg">下一篇</span> <span class="hidden-xs">Java面向对象设计之装饰模式</span><i class="fa fa-angle-right fa-fw"></i></a></div><div id="comments"><p>评论系统未开启，无法评论！</p></div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9312750344484857" data-ad-slot="2669241897" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></main><aside class="col-md-4 sidebar"><div class="widget"><h3 class="title">赞助广告</h3><ins class="adsbygoogle" style="display:block;width:100%;height:280px" data-ad-client="ca-pub-9312750344484857" data-ad-slot="2014094445" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><p style="text-align:center">想要出现再此！</p></div><div class="widget"><h3 class="title">分类</h3><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/category/Mac-OS/"><i class="fa" aria-hidden="true">Mac OS</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/Nuxtjs/"><i class="fa" aria-hidden="true">Nuxtjs</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/Objective-C/"><i class="fa" aria-hidden="true">Objective-C</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/babel/"><i class="fa" aria-hidden="true">babel</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/css/"><i class="fa" aria-hidden="true">css</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/danger/"><i class="fa" aria-hidden="true">danger</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/data-structure/"><i class="fa" aria-hidden="true">data structure</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/design/"><i class="fa" aria-hidden="true">design</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/es6/"><i class="fa" aria-hidden="true">es6</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/es7/"><i class="fa" aria-hidden="true">es7</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/eslint/"><i class="fa" aria-hidden="true">eslint</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/flutter/"><i class="fa" aria-hidden="true">flutter</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/git/"><i class="fa" aria-hidden="true">git</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/github/"><i class="fa" aria-hidden="true">github</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/golang/"><i class="fa" aria-hidden="true">golang</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/http/"><i class="fa" aria-hidden="true">http</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/java/"><i class="fa" aria-hidden="true">java</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/javascript/"><i class="fa" aria-hidden="true">javascript</i></a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/jest/"><i class="fa" aria-hidden="true">jest</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/koa/"><i class="fa" aria-hidden="true">koa</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/lerna/"><i class="fa" aria-hidden="true">lerna</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/linux/"><i class="fa" aria-hidden="true">linux</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/mysql/"><i class="fa" aria-hidden="true">mysql</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/netlify/"><i class="fa" aria-hidden="true">netlify</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/nginx/"><i class="fa" aria-hidden="true">nginx</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/nodejs/"><i class="fa" aria-hidden="true">nodejs</i></a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/npm/"><i class="fa" aria-hidden="true">npm</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/programm/"><i class="fa" aria-hidden="true">programm</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/react/"><i class="fa" aria-hidden="true">react</i></a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/redux/"><i class="fa" aria-hidden="true">redux</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/redux-thunk/"><i class="fa" aria-hidden="true">redux-thunk</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/regex/"><i class="fa" aria-hidden="true">regex</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/rollup/"><i class="fa" aria-hidden="true">rollup</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/shell/"><i class="fa" aria-hidden="true">shell</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/sketch/"><i class="fa" aria-hidden="true">sketch</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/the-super-tiny-compiler/"><i class="fa" aria-hidden="true">the-super-tiny-compiler</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/threejs/"><i class="fa" aria-hidden="true">threejs</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/typescript/"><i class="fa" aria-hidden="true">typescript</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/vscode/"><i class="fa" aria-hidden="true">vscode</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/vue/"><i class="fa" aria-hidden="true">vue</i></a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/vue-router/"><i class="fa" aria-hidden="true">vue-router</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/vuex/"><i class="fa" aria-hidden="true">vuex</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/webpack/"><i class="fa" aria-hidden="true">webpack</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/wechat/"><i class="fa" aria-hidden="true">wechat</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link current" href="/blog/category/%E5%89%8D%E7%AB%AF/"><i class="fa" aria-hidden="true">前端</i></a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E5%90%8E%E7%AB%AF/"><i class="fa" aria-hidden="true">后端</i></a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E5%BB%BA%E7%AB%99%E6%95%99%E7%A8%8B/"><i class="fa" aria-hidden="true">建站教程</i></a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="fa" aria-hidden="true">数据库</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E6%9D%82%E8%B0%88/"><i class="fa" aria-hidden="true">杂谈</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E7%A7%91%E6%8A%80%E7%88%B1%E5%A5%BD%E8%80%85%E5%91%A8%E5%88%8A-%E9%98%AE%E4%B8%80%E5%B3%B0/"><i class="fa" aria-hidden="true">科技爱好者周刊(阮一峰)</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93/"><i class="fa" aria-hidden="true">编程之道</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/"><i class="fa" aria-hidden="true">软件工具</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/category/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1/"><i class="fa" aria-hidden="true">软件设计</i></a><span class="category-list-count">16</span></li></ul></div><div class="widget"><h3 class="title">归档</h3><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/2020/03/"><i class="fa" aria-hidden="true">2020年03月</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2020/01/"><i class="fa" aria-hidden="true">2020年01月</i></a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/12/"><i class="fa" aria-hidden="true">2019年12月</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/11/"><i class="fa" aria-hidden="true">2019年11月</i></a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/08/"><i class="fa" aria-hidden="true">2019年08月</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/07/"><i class="fa" aria-hidden="true">2019年07月</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/04/"><i class="fa" aria-hidden="true">2019年04月</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/03/"><i class="fa" aria-hidden="true">2019年03月</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/02/"><i class="fa" aria-hidden="true">2019年02月</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2019/01/"><i class="fa" aria-hidden="true">2019年01月</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/12/"><i class="fa" aria-hidden="true">2018年12月</i></a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/11/"><i class="fa" aria-hidden="true">2018年11月</i></a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/10/"><i class="fa" aria-hidden="true">2018年10月</i></a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/09/"><i class="fa" aria-hidden="true">2018年09月</i></a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/08/"><i class="fa" aria-hidden="true">2018年08月</i></a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/07/"><i class="fa" aria-hidden="true">2018年07月</i></a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/06/"><i class="fa" aria-hidden="true">2018年06月</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/05/"><i class="fa" aria-hidden="true">2018年05月</i></a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/04/"><i class="fa" aria-hidden="true">2018年04月</i></a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/2018/03/"><i class="fa" aria-hidden="true">2018年03月</i></a><span class="archive-list-count">1</span></li></ul></div><div class="widget"><h3 class="title">标签云</h3><div class="content tag-cloud"><a href="/blog/tagged/Apache/" style="font-size:13.33px">Apache</a> <a href="/blog/tagged/CPU%E7%BC%93%E5%AD%98/" style="font-size:10px">CPU缓存</a> <a href="/blog/tagged/CSS/" style="font-size:10px">CSS</a> <a href="/blog/tagged/Cryptojs/" style="font-size:10px">Cryptojs</a> <a href="/blog/tagged/DevOps/" style="font-size:10px">DevOps</a> <a href="/blog/tagged/Equality-operator/" style="font-size:10px">Equality operator</a> <a href="/blog/tagged/Fenix/" style="font-size:10px">Fenix</a> <a href="/blog/tagged/Git/" style="font-size:10px">Git</a> <a href="/blog/tagged/GitLab-CI/" style="font-size:10px">GitLab CI</a> <a href="/blog/tagged/Google/" style="font-size:10px">Google</a> <a href="/blog/tagged/JAVA-HOME/" style="font-size:10px">JAVA_HOME</a> <a href="/blog/tagged/JPA/" style="font-size:10px">JPA</a> <a href="/blog/tagged/Java/" style="font-size:20px">Java</a> <a href="/blog/tagged/JavaScript/" style="font-size:14.44px">JavaScript</a> <a href="/blog/tagged/Jenkins/" style="font-size:10px">Jenkins</a> <a href="/blog/tagged/Linux/" style="font-size:13.33px">Linux</a> <a href="/blog/tagged/MVEL/" style="font-size:11.11px">MVEL</a> <a href="/blog/tagged/Markdown/" style="font-size:10px">Markdown</a> <a href="/blog/tagged/PostgreSQL/" style="font-size:10px">PostgreSQL</a> <a href="/blog/tagged/React-Fire/" style="font-size:10px">React Fire</a> <a href="/blog/tagged/Semicolon/" style="font-size:10px">Semicolon</a> <a href="/blog/tagged/Spring/" style="font-size:11.11px">Spring</a> <a href="/blog/tagged/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/blog/tagged/Typora/" style="font-size:10px">Typora</a> <a href="/blog/tagged/UML/" style="font-size:11.11px">UML</a> <a href="/blog/tagged/Vue/" style="font-size:10px">Vue</a> <a href="/blog/tagged/ajax/" style="font-size:10px">ajax</a> <a href="/blog/tagged/analysis-package/" style="font-size:10px">analysis package</a> <a href="/blog/tagged/async/" style="font-size:10px">async</a> <a href="/blog/tagged/cheerio/" style="font-size:10px">cheerio</a> <a href="/blog/tagged/commit-message/" style="font-size:10px">commit message</a> <a href="/blog/tagged/communication/" style="font-size:10px">communication</a> <a href="/blog/tagged/component/" style="font-size:10px">component</a> <a href="/blog/tagged/currying/" style="font-size:10px">currying</a> <a href="/blog/tagged/decorator/" style="font-size:10px">decorator</a> <a href="/blog/tagged/fiber/" style="font-size:10px">fiber</a> <a href="/blog/tagged/fix-bug/" style="font-size:10px">fix bug</a> <a href="/blog/tagged/function/" style="font-size:10px">function</a> <a href="/blog/tagged/git-clone/" style="font-size:10px">git clone</a> <a href="/blog/tagged/golang/" style="font-size:10px">golang</a> <a href="/blog/tagged/hexo/" style="font-size:14.44px">hexo</a> <a href="/blog/tagged/hooks/" style="font-size:10px">hooks</a> <a href="/blog/tagged/http/" style="font-size:10px">http</a> <a href="/blog/tagged/justify/" style="font-size:10px">justify</a> <a href="/blog/tagged/let/" style="font-size:10px">let</a> <a href="/blog/tagged/login/" style="font-size:10px">login</a> <a href="/blog/tagged/module/" style="font-size:11.11px">module</a> <a href="/blog/tagged/nginx/" style="font-size:11.11px">nginx</a> <a href="/blog/tagged/note/" style="font-size:18.89px">note</a> <a href="/blog/tagged/npm/" style="font-size:11.11px">npm</a> <a href="/blog/tagged/npx/" style="font-size:10px">npx</a> <a href="/blog/tagged/open/" style="font-size:10px">open</a> <a href="/blog/tagged/package/" style="font-size:10px">package</a> <a href="/blog/tagged/package-json/" style="font-size:10px">package.json</a> <a href="/blog/tagged/path/" style="font-size:10px">path</a> <a href="/blog/tagged/pm2/" style="font-size:11.11px">pm2</a> <a href="/blog/tagged/promise/" style="font-size:10px">promise</a> <a href="/blog/tagged/refs/" style="font-size:10px">refs</a> <a href="/blog/tagged/rem/" style="font-size:10px">rem</a> <a href="/blog/tagged/render/" style="font-size:10px">render</a> <a href="/blog/tagged/require/" style="font-size:10px">require</a> <a href="/blog/tagged/rzero/" style="font-size:10px">rzero</a> <a href="/blog/tagged/selector/" style="font-size:10px">selector</a> <a href="/blog/tagged/service/" style="font-size:10px">service</a> <a href="/blog/tagged/setTimeout/" style="font-size:10px">setTimeout</a> <a href="/blog/tagged/source/" style="font-size:16.67px">source</a> <a href="/blog/tagged/ssh/" style="font-size:10px">ssh</a> <a href="/blog/tagged/ssr/" style="font-size:10px">ssr</a> <a href="/blog/tagged/timer/" style="font-size:10px">timer</a> <a href="/blog/tagged/tools/" style="font-size:10px">tools</a> <a href="/blog/tagged/tree-shaking/" style="font-size:10px">tree-shaking</a> <a href="/blog/tagged/typecho/" style="font-size:15.56px">typecho</a> <a href="/blog/tagged/typecho%E6%8F%92%E4%BB%B6/" style="font-size:15.56px">typecho插件</a> <a href="/blog/tagged/types/" style="font-size:10px">types</a> <a href="/blog/tagged/utils/" style="font-size:10px">utils</a> <a href="/blog/tagged/virtual-dom/" style="font-size:10px">virtual dom</a> <a href="/blog/tagged/vscode/" style="font-size:10px">vscode</a> <a href="/blog/tagged/wasm/" style="font-size:13.33px">wasm</a> <a href="/blog/tagged/webassembly/" style="font-size:13.33px">webassembly</a> <a href="/blog/tagged/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size:10px">位运算</a> <a href="/blog/tagged/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size:11.11px">单元测试</a> <a href="/blog/tagged/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" style="font-size:10px">性能测试</a> <a href="/blog/tagged/%E6%95%B4%E6%B4%81%E4%BB%A3%E7%A0%81/" style="font-size:10px">整洁代码</a> <a href="/blog/tagged/%E6%B5%8B%E8%AF%95/" style="font-size:10px">测试</a> <a href="/blog/tagged/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" style="font-size:10px">设计原则</a> <a href="/blog/tagged/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:17.78px">设计模式</a> <a href="/blog/tagged/%E9%87%8D%E6%9E%84/" style="font-size:10px">重构</a> <a href="/blog/tagged/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/" style="font-size:12.22px">面向对象编程</a></div></div></aside></div></div></section><footer class="main-footer"><div class="container"><div class="row"></div></div></footer><a id="back-to-top" class="icon-btn hide"><i class="fa fa-chevron-up"></i></a><div class="copyright"><div class="container"><div class="row"><div class="col-sm-12"><div class="busuanzi"></div></div><div class="col-sm-12"><span>Copyright &copy; 2021 - 2022 Liuxfe</span></div></div></div></div><script src="/js/app.js?rev=@@hash.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?bc24c40486ac78730f85549d164dac6f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-195431371-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-195431371-1")</script></body></html>